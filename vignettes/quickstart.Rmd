---
title: "Getting Started with caschooldata"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with caschooldata}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,
  fig.height = 4,
  cache = TRUE
)
```

## Overview

The `caschooldata` package provides tools for fetching and analyzing California school enrollment data from the California Department of Education (CDE). This vignette walks through the main features of the package.

**What you'll find in the data:**

- 8 years of enrollment data (2018-2025)
- 5.8+ million students across 1,000+ districts
- Demographic breakdowns by race/ethnicity, gender, and student groups
- Trends showing 400,000+ student decline since 2018

For a deep dive into trends and findings, see the [District Trends & Demographics](district-highlights.html) vignette.

## Installation

Install from GitHub:

```r
# install.packages("remotes")
remotes::install_github("almartin82/caschooldata")
```

## Fetching Enrollment Data

### Basic Usage

The main function is `fetch_enr()`, which downloads and processes enrollment data for a given school year:

```{r fetch-data}
library(caschooldata)
library(dplyr)

# Fetch 2025 enrollment data (2024-25 school year)
enr <- fetch_enr(2025, use_cache = TRUE)

head(enr)
```

The `end_year` parameter refers to the spring semester year. For example, `end_year = 2025` fetches data for the 2024-25 school year.

### Available Years

The package supports Census Day enrollment data from 2018-2025:

- **2024-2025**: Modern Census Day files with full demographic breakdowns
- **2018-2023**: Historical school-level files with race/ethnicity and gender data

```{r years-example}
# Fetch the most recent year
enr_2025 <- enr  # already fetched above

# State totals (filter to charter_status "All" to avoid tripling in 2024+)
enr_2025 %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL",
         charter_status %in% c("All", NA))
```

### Wide vs. Tidy Format

By default, `fetch_enr()` returns data in **tidy (long) format**, which is ideal for analysis with dplyr and ggplot2:

```{r tidy-format}
# Default: tidy format
names(enr)
# Includes: grade_level, reporting_category, subgroup, n_students
```

For wide format (one column per grade), set `tidy = FALSE`:

```{r wide-format}
# Wide format: one column per grade
enr_wide <- fetch_enr(2025, tidy = FALSE, use_cache = TRUE)
names(enr_wide)
# Includes: grade_tk, grade_k, grade_01, ..., grade_12, total_enrollment
```

### Fetching Multiple Years

Use `fetch_enr_multi()` to download data for multiple years at once:

```{r multi-year}
# Fetch 2024 and 2025 data
all_years <- fetch_enr_multi(c(2024, 2025), use_cache = TRUE)

# Analyze enrollment trends
all_years %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL",
         charter_status %in% c("All", NA)) %>%
  select(end_year, n_students)
```

## Understanding the Data Schema

### Column Descriptions

The tidy enrollment data includes the following columns:

| Column | Description |
|--------|-------------|
| `end_year` | School year end (e.g., 2024 for 2023-24) |
| `academic_year` | Academic year string (e.g., "2023-24") |
| `cds_code` | 14-digit County-District-School identifier |
| `county_code` | 2-digit county code (01-58) |
| `district_code` | 5-digit district code |
| `school_code` | 7-digit school code |
| `agg_level` | Aggregation level: T (State), C (County), D (District), S (School) |
| `county_name` | County name |
| `district_name` | District name |
| `school_name` | School name |
| `charter_status` | Y (Charter), N (Non-Charter), or All |
| `grade_level` | Grade: TK, K, 01-12, or TOTAL |
| `reporting_category` | CDE demographic category code |
| `subgroup` | Human-readable subgroup name |
| `n_students` | Enrollment count |
| `is_state`, `is_county`, `is_district`, `is_school` | Boolean aggregation flags |
| `is_charter` | Boolean charter indicator |

### Aggregation Levels

The data includes four aggregation levels:

```{r agg-levels}
# State-level totals
state <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL",
         charter_status %in% c("All", NA))
cat("State total:", scales::comma(state$n_students), "\n")

# County-level (58 California counties)
counties <- enr %>%
  filter(is_county, subgroup == "total_enrollment", grade_level == "TOTAL",
         charter_status %in% c("All", NA))
cat("Number of counties:", nrow(counties), "\n")

# District-level
districts <- enr %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         charter_status %in% c("All", NA))
cat("Number of districts:", nrow(districts), "\n")
```

### Demographic Subgroups

The `reporting_category` column contains CDE codes, while `subgroup` provides human-readable names:

| Category | Code | Subgroup Name |
|----------|------|---------------|
| Total | TA | total_enrollment |
| Race/Ethnicity | RE_H | hispanic |
| Race/Ethnicity | RE_W | white |
| Race/Ethnicity | RE_A | asian |
| Race/Ethnicity | RE_B | black |
| Race/Ethnicity | RE_F | filipino |
| Race/Ethnicity | RE_P | pacific_islander |
| Race/Ethnicity | RE_I | native_american |
| Race/Ethnicity | RE_T | multiracial |
| Gender | GN_F | female |
| Gender | GN_M | male |
| Gender | GN_X | nonbinary |
| Student Groups | SG_EL | english_learner |
| Student Groups | SG_DS | special_ed |
| Student Groups | SG_SD | econ_disadv |
| Student Groups | SG_FS | foster_youth |
| Student Groups | SG_HM | homeless |
| Student Groups | SG_MG | migrant |

```{r subgroups}
# View all available subgroups for 2025
enr %>%
  filter(is_state, grade_level == "TOTAL", charter_status %in% c("All", NA)) %>%
  distinct(reporting_category, subgroup) %>%
  arrange(reporting_category)
```

### Grade Levels

Individual grades range from Transitional Kindergarten (TK) through 12th grade:

```{r grades}
# Available grade levels
enr %>%
  distinct(grade_level) %>%
  arrange(grade_level)
```

## Filtering and Analysis Examples

### Top 10 Largest Districts

```{r top-districts}
enr %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL",
         charter_status %in% c("All", NA)) %>%
  arrange(desc(n_students)) %>%
  select(district_name, county_name, n_students) %>%
  head(10)
```

### County-Level Analysis

```{r county-analysis}
# Enrollment by county
county_enrollment <- enr %>%
  filter(is_county, subgroup == "total_enrollment", grade_level == "TOTAL",
         charter_status %in% c("All", NA)) %>%
  arrange(desc(n_students)) %>%
  select(county_name, n_students)

# Top 5 counties
head(county_enrollment, 5)
```

### Demographic Breakdown

```{r demographics}
# State-level race/ethnicity breakdown
enr %>%
  filter(
    is_state,
    grade_level == "TOTAL",
    charter_status %in% c("All", NA),
    grepl("^RE_", reporting_category)
  ) %>%
  mutate(pct = n_students / sum(n_students) * 100) %>%
  select(subgroup, n_students, pct) %>%
  arrange(desc(n_students))
```

### Charter vs. Non-Charter Comparison

```{r charter-comparison}
# State-level charter enrollment (only available 2024+)
charter_comparison <- enr %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  select(charter_status, n_students) %>%
  arrange(charter_status)

charter_comparison
```

### Grade-Level Aggregations

Use `enr_grade_aggs()` to create grade band summaries:

```{r grade-aggs}
# Create K-8, HS, K-12 aggregations
grade_bands <- enr_grade_aggs(enr)

# View state-level grade bands (filter charter_status)
grade_bands %>%
  filter(is_state, charter_status %in% c("All", NA)) %>%
  select(grade_level, n_students)
```

## Working with CDS Codes

California uses a 14-digit County-District-School (CDS) code system:

- **Positions 1-2**: County code (01-58)
- **Positions 3-7**: District code (5 digits)
- **Positions 8-14**: School code (7 digits)

```{r cds-codes}
# Parse a CDS code
parse_cds_code("19647331932334")
# Returns: list(county = "19", district = "64733", school = "1932334")
```

## Visualization Examples

### Bar Chart: Top Counties

```{r viz-counties}
library(ggplot2)

# Top 10 counties by enrollment
top_counties <- enr %>%
  filter(is_county, subgroup == "total_enrollment", grade_level == "TOTAL",
         charter_status %in% c("All", NA)) %>%
  arrange(desc(n_students)) %>%
  head(10)

ggplot(top_counties, aes(x = reorder(county_name, n_students), y = n_students)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  scale_y_continuous(labels = scales::comma) +
  labs(
    title = "Top 10 California Counties by Enrollment",
    subtitle = "2024-25 School Year",
    x = NULL,
    y = "Total Enrollment"
  ) +
  theme_minimal()
```

### Demographic Composition

```{r viz-demographics}
# Race/ethnicity bar chart
race_data <- enr %>%
  filter(
    is_state,
    grade_level == "TOTAL",
    charter_status %in% c("All", NA),
    grepl("^RE_", reporting_category)
  ) %>%
  mutate(pct = n_students / sum(n_students) * 100) %>%
  select(subgroup, n_students, pct) %>%
  arrange(desc(pct))

ggplot(race_data, aes(x = reorder(subgroup, pct), y = pct, fill = subgroup)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "California Enrollment by Race/Ethnicity (2025)",
    x = NULL,
    y = "Percent"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

## Cache Management

The package caches downloaded data locally to avoid repeated downloads:

```{r cache-management}
# Check what's cached
cache_status()
```

The cache is stored in a user-specific application data directory (via `rappdirs`). Cached data persists between R sessions.

## Data Quality Notes

- Enrollment counts are based on **Census Day** (first Wednesday in October)
- Some cells may be suppressed for privacy (small counts)
- **Charter Status (2024+)**: Modern data reports "All", "N", "Y" separately. Always filter to `charter_status %in% c("All", NA)` for deduplicated totals.
- State and county totals may include students not assigned to specific schools

## Next Steps

- See the [District Trends & Demographics vignette](district-highlights.html) for data-driven findings
- Explore the [Data Quality QA vignette](data-quality-qa.html) for validation examples
- Check the function reference for detailed documentation: `?fetch_enr`, `?tidy_enr`
- Visit the [package website](https://almartin82.github.io/caschooldata/) for more resources

## Session Info

```{r session-info}
sessionInfo()
```
