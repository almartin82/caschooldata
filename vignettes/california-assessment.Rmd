---
title: "California CAASPP Assessment Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{California CAASPP Assessment Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE,
  fig.width = 10,
  fig.height = 6
)
```

```{r load-packages, message=FALSE, warning=FALSE}
library(caschooldata)
library(dplyr)
library(tidyr)
library(ggplot2)

# Set theme
theme_set(theme_minimal(base_size = 12))
```

## Introduction

California's CAASPP (California Assessment of Student Performance and Progress) system includes the Smarter Balanced assessments for English Language Arts (ELA) and Mathematics. This vignette demonstrates how to fetch, analyze, and visualize California assessment data using the `caschooldata` package.

**Available Years:** 2021-2025 (no 2020 due to COVID-19; pre-2021 data has a known parsing issue)

**Data Source:** [CAASPP Research Files Portal](https://caaspp-elpac.ets.org/caaspp/ResearchFileListSB)

---

## 1. Fetching Assessment Data

```{r fetch-2024}
# Fetch 2024 assessment data
assess_2024 <- fetch_assess(2024, tidy = TRUE, use_cache = TRUE)

# View structure
glimpse(assess_2024)
```

```{r state-summary}
# State-level summary (all grades combined, grade "13")
state_2024 <- assess_2024 %>%
  filter(is_state, grade == "13", metric_type == "pct_met_and_above") %>%
  select(subject, metric_value) %>%
  arrange(subject)

stopifnot(nrow(state_2024) > 0)

state_2024
```

---

## 2. Grade 11 proficiency: 55.7% in ELA, 27.9% in Math

California's 11th graders showed a nearly 28-point gap between ELA and Math proficiency in 2024 — less than a third of juniors met standards in Math.

```{r finding-1}
# State-level proficiency by subject (Grade 11)
state_g11 <- assess_2024 %>%
  filter(is_state, grade == "11", metric_type == "pct_met_and_above") %>%
  select(subject, metric_value)

stopifnot(nrow(state_g11) > 0)

state_g11
```

```{r finding-1-plot}
ggplot(state_g11, aes(x = subject, y = metric_value, fill = subject)) +
  geom_col(width = 0.6) +
  geom_text(aes(label = paste0(round(metric_value, 1), "%")),
            vjust = -0.5, size = 5) +
  labs(
    title = "California Grade 11 CAASPP Proficiency (2024)",
    subtitle = "Percentage of students meeting or exceeding standards",
    x = NULL,
    y = "Percent Proficient"
  ) +
  scale_fill_manual(values = c("ELA" = "#2E86AB", "Math" = "#A23B72")) +
  scale_y_continuous(limits = c(0, 70), expand = c(0, 0)) +
  theme(legend.position = "none")
```

---

## 3. High schoolers outperform elementary in ELA

Grade 11 students have the highest ELA proficiency (55.7%), significantly above Grade 3 (42.8%). Unlike most states, California's ELA proficiency rises with grade level.

```{r finding-2}
# ELA proficiency by grade
ela_by_grade <- assess_2024 %>%
  filter(is_state, subject == "ELA",
         metric_type == "pct_met_and_above",
         grade %in% sprintf("%02d", c(3:8, 11))) %>%
  select(grade, metric_value) %>%
  arrange(grade)

stopifnot(nrow(ela_by_grade) > 0)

ela_by_grade
```

```{r finding-2-plot}
ggplot(ela_by_grade, aes(x = grade, y = metric_value)) +
  geom_col(fill = "#2E86AB") +
  geom_text(aes(label = paste0(round(metric_value, 1), "%")),
            vjust = -0.5, size = 4) +
  labs(
    title = "California ELA Proficiency by Grade (2024)",
    subtitle = "Proficiency rises from Grade 3 (42.8%) to Grade 11 (55.7%)",
    x = "Grade",
    y = "Percent Proficient"
  ) +
  scale_y_continuous(limits = c(0, 65), expand = c(0, 0))
```

---

## 4. Math proficiency drops dramatically by middle school

Math proficiency peaks in Grade 3 at 45.6% and falls to under 32% by Grade 8. By Grade 11, only 27.9% of students meet standards.

```{r finding-3}
# Math proficiency by grade
math_by_grade <- assess_2024 %>%
  filter(is_state, subject == "Math",
         metric_type == "pct_met_and_above",
         grade %in% sprintf("%02d", c(3:8, 11))) %>%
  select(grade, metric_value) %>%
  arrange(grade)

stopifnot(nrow(math_by_grade) > 0)

math_by_grade
```

```{r finding-3-plot}
ggplot(math_by_grade, aes(x = grade, y = metric_value)) +
  geom_col(fill = "#A23B72") +
  geom_text(aes(label = paste0(round(metric_value, 1), "%")),
            vjust = -0.5, size = 4) +
  labs(
    title = "California Math Proficiency by Grade (2024)",
    subtitle = "Peaks at Grade 3 (45.6%), falls to 27.9% by Grade 11",
    x = "Grade",
    y = "Percent Proficient"
  ) +
  scale_y_continuous(limits = c(0, 55), expand = c(0, 0))
```

---

## 5. Mean scale scores show consistent patterns

Mean scale scores increase with grade level, reflecting expected growth across the K-12 continuum.

```{r finding-4}
# Mean scale scores by grade and subject
mean_scores <- assess_2024 %>%
  filter(is_state, metric_type == "mean_scale_score",
         grade %in% sprintf("%02d", c(3:8, 11))) %>%
  select(grade, subject, metric_value) %>%
  arrange(subject, grade)

stopifnot(nrow(mean_scores) > 0)

mean_scores %>%
  pivot_wider(names_from = subject, values_from = metric_value)
```

```{r finding-4-plot}
ggplot(mean_scores, aes(x = grade, y = metric_value, color = subject, group = subject)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  labs(
    title = "California CAASPP Mean Scale Scores by Grade (2024)",
    x = "Grade",
    y = "Mean Scale Score",
    color = "Subject"
  ) +
  scale_color_manual(values = c("ELA" = "#2E86AB", "Math" = "#A23B72"))
```

---

## 6. Multi-year trends: 2021 was the peak, not a trough

Surprisingly, Grade 11 ELA proficiency peaked in 2021 at 59.2% — the first post-COVID test year — then fell to 54.8% in 2022 and has slowly recovered to 55.7% in 2024. This may reflect selective participation in 2021 (only motivated students tested during COVID).

```{r fetch-multi}
# Fetch multiple years (2021-2024 available)
assess_multi <- fetch_assess_multi(c(2021, 2022, 2023, 2024),
                                    tidy = TRUE, use_cache = TRUE)
```

```{r finding-5}
# State-level trend
state_trend <- assess_multi %>%
  filter(is_state, grade == "11", metric_type == "pct_met_and_above") %>%
  select(end_year, subject, metric_value) %>%
  arrange(subject, end_year)

stopifnot(nrow(state_trend) > 0)

state_trend %>%
  pivot_wider(names_from = subject, values_from = metric_value)
```

```{r finding-5-plot}
ggplot(state_trend, aes(x = end_year, y = metric_value, color = subject)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  labs(
    title = "California Grade 11 CAASPP Proficiency Trend (2021-2024)",
    subtitle = "2021 was the peak (possibly due to selective participation), not a pandemic low",
    x = "Year",
    y = "Percent Proficient",
    color = "Subject"
  ) +
  scale_color_manual(values = c("ELA" = "#2E86AB", "Math" = "#A23B72")) +
  scale_x_continuous(breaks = c(2021, 2022, 2023, 2024))
```

---

## 7. ELA fell after 2021 and has not recovered to its peak

ELA proficiency dropped 4.4 points from 2021 to 2022, and by 2024 was still 3.5 points below the 2021 level.

```{r finding-6}
# ELA recovery
ela_recovery <- state_trend %>%
  filter(subject == "ELA") %>%
  mutate(
    change_from_2021 = metric_value - first(metric_value),
    change_from_prev = metric_value - lag(metric_value)
  )

stopifnot(nrow(ela_recovery) > 0)

ela_recovery
```

---

## 8. Math recovery lagged behind ELA

Math proficiency dropped 7.4 points from 2021 to 2022 and has only recovered 0.9 points through 2024. Math remains well below the 2021 level.

```{r finding-7}
# Math recovery
math_recovery <- state_trend %>%
  filter(subject == "Math") %>%
  mutate(
    change_from_2021 = metric_value - first(metric_value),
    change_from_prev = metric_value - lag(metric_value)
  )

stopifnot(nrow(math_recovery) > 0)

math_recovery
```

---

## 9. Over 2.9 million students tested in 2024

California's CAASPP program is one of the largest state assessments in the country.

```{r finding-8}
# Total students tested
tested_count <- assess_2024 %>%
  filter(is_state, grade == "13", metric_type == "n_tested") %>%
  select(subject, metric_value)

stopifnot(nrow(tested_count) > 0)

tested_count
```

---

## 10. Grade 3 had the highest participation rate

Third grade ELA had the most students tested, reflecting high participation in early grades.

```{r finding-9}
# Students tested by grade
tested_by_grade <- assess_2024 %>%
  filter(is_state, subject == "ELA", metric_type == "n_tested",
         grade %in% sprintf("%02d", c(3:8, 11))) %>%
  select(grade, metric_value) %>%
  arrange(grade)

stopifnot(nrow(tested_by_grade) > 0)

tested_by_grade
```

```{r finding-9-plot}
ggplot(tested_by_grade, aes(x = grade, y = metric_value / 1000)) +
  geom_col(fill = "#2E86AB") +
  labs(
    title = "California ELA Students Tested by Grade (2024)",
    x = "Grade",
    y = "Students Tested (thousands)"
  ) +
  scale_y_continuous(labels = scales::comma)
```

---

## 11. Performance levels show a range of achievement

Students are distributed across four performance levels, with "Standard Not Met" being the largest single category in Math.

```{r finding-10}
# Performance level distribution (Grade 11 Math)
perf_levels <- assess_2024 %>%
  filter(is_state, grade == "11", subject == "Math",
         metric_type %in% c("pct_exceeded", "pct_met", "pct_nearly_met", "pct_not_met")) %>%
  select(metric_type, metric_value) %>%
  mutate(
    level = case_when(
      metric_type == "pct_exceeded" ~ "Exceeded Standard",
      metric_type == "pct_met" ~ "Met Standard",
      metric_type == "pct_nearly_met" ~ "Nearly Met",
      metric_type == "pct_not_met" ~ "Not Met"
    ),
    level = factor(level, levels = c("Exceeded Standard", "Met Standard",
                                      "Nearly Met", "Not Met"))
  )

stopifnot(nrow(perf_levels) > 0)

perf_levels
```

```{r finding-10-plot}
ggplot(perf_levels, aes(x = "", y = metric_value, fill = level)) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  labs(
    title = "California Grade 11 Math Performance Levels (2024)",
    fill = "Performance Level"
  ) +
  theme_void() +
  scale_fill_manual(values = c(
    "Exceeded Standard" = "#1B9E77",
    "Met Standard" = "#66A61E",
    "Nearly Met" = "#E6AB02",
    "Not Met" = "#D95F02"
  ))
```

---

## 12. District-level variation is substantial

Top-performing districts have proficiency rates 30+ points higher than state average.

```{r finding-11}
# District proficiency (Grade 11 ELA)
district_ela <- assess_2024 %>%
  filter(is_district, grade == "11", subject == "ELA",
         metric_type == "pct_met_and_above") %>%
  select(cds_code, metric_value) %>%
  filter(!is.na(metric_value)) %>%
  arrange(desc(metric_value))

stopifnot(nrow(district_ela) > 0)

# Top 10 districts by CDS code
head(district_ela, 10)
```

---

## 13. Bottom-performing districts face significant challenges

Some districts have proficiency rates under 20%, highlighting achievement gaps.

```{r finding-12}
# Bottom 10 districts (with at least 100 students)
district_ela_filtered <- assess_2024 %>%
  filter(is_district, grade == "11", subject == "ELA") %>%
  select(cds_code, metric_type, metric_value) %>%
  pivot_wider(names_from = metric_type, values_from = metric_value) %>%
  filter(!is.na(pct_met_and_above), n_tested >= 100) %>%
  arrange(pct_met_and_above)

stopifnot(nrow(district_ela_filtered) > 0)

head(district_ela_filtered %>% select(cds_code, pct_met_and_above, n_tested), 10)
```

---

## 14. Large urban districts represent significant enrollment

The largest districts in California serve hundreds of thousands of students.

```{r finding-13}
# Major district CDS codes
# Los Angeles Unified = 19647330000000
# San Diego Unified = 37683380000000
major_district_codes <- c("19647330000000", "37683380000000",
                          "10621660000000", "38684780000000")  # Fresno, SF

major_district_data <- assess_2024 %>%
  filter(is_district, grade == "11",
         metric_type %in% c("pct_met_and_above", "n_tested"),
         cds_code %in% major_district_codes) %>%
  select(cds_code, subject, metric_type, metric_value) %>%
  pivot_wider(names_from = metric_type, values_from = metric_value)

stopifnot(nrow(major_district_data) > 0)

major_district_data
```

---

## 15. ELA-Math gap ranges from -2.8 to +27.8 points across grades

The gap between ELA and Math proficiency is NOT consistent across grades. In Grade 3, Math actually outperforms ELA by 2.8 points. By Grade 11, the gap balloons to 27.8 points in ELA's favor. This widening gap reflects the cumulative struggle with math as concepts become more abstract.

```{r finding-14}
# ELA-Math gap by grade
ela_math_gap <- assess_2024 %>%
  filter(is_state, metric_type == "pct_met_and_above",
         grade %in% sprintf("%02d", c(3:8, 11))) %>%
  select(grade, subject, metric_value) %>%
  pivot_wider(names_from = subject, values_from = metric_value) %>%
  mutate(gap = ELA - Math)

stopifnot(nrow(ela_math_gap) > 0)

ela_math_gap
```

```{r finding-14-plot}
ggplot(ela_math_gap, aes(x = grade, y = gap)) +
  geom_col(fill = ifelse(ela_math_gap$gap >= 0, "#2E86AB", "#A23B72")) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_text(aes(label = sprintf("%+.1f", gap)),
            vjust = ifelse(ela_math_gap$gap >= 0, -0.5, 1.5), size = 4) +
  labs(
    title = "ELA vs Math Proficiency Gap by Grade (2024)",
    subtitle = "Grade 3: Math leads by 2.8 pts. Grade 11: ELA leads by 27.8 pts.",
    x = "Grade",
    y = "ELA - Math (percentage points)"
  ) +
  scale_y_continuous(limits = c(-5, 32))
```

---

## Data Notes

- **Source**: California Department of Education CAASPP Research Files
- **Years Available**: 2021-2025 (pre-2021 has known column mapping issues; no 2020 due to COVID-19)
- **Grades Tested**: 3-8 and 11 for ELA and Mathematics
- **Suppression**: Groups with fewer than 11 students are not reported
- **Performance Levels**: Standard Exceeded, Standard Met, Standard Nearly Met, Standard Not Met
- **2021 caveat**: Limited and potentially selective participation makes 2021 data not directly comparable to later years

---

## Session Info

```{r session-info}
sessionInfo()
```
