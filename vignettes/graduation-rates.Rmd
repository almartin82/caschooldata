---
title: "California Graduation Rate Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{California Graduation Rate Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,
  fig.height = 4.5,
  cache = TRUE
)
```

## Overview

California's graduation rates vary significantly across districts, demographics, and student groups. This vignette shows how to fetch and analyze graduation rate data from the California Department of Education.

**Key insights you'll discover:**
- Statewide graduation rates have improved from 84% to 88% since 2018
- Significant disparities exist across demographic groups
- Top-performing districts consistently maintain 97%+ graduation rates
- The gap between Asian and Black students is 13 percentage points

## Fetching Graduation Data

### Single Year

Fetch graduation rates for a specific school year:

```{r fetch-single}
library(caschooldata)
library(dplyr)
library(ggplot2)

# Get 2024 graduation rates (2023-24 school year)
grad_2024 <- fetch_graduation(2024, use_cache = TRUE)

# Statewide overview
state_overview <- grad_2024 %>%
  filter(is_state, subgroup == "all") %>%
  select(grad_rate, cohort_count, graduate_count)

stopifnot(nrow(state_overview) > 0)
state_overview
```

### Multiple Years

Fetch multiple years for trend analysis:

```{r fetch-multi}
# Get multiple years of graduation data
# Available years: 2018, 2019, 2022, 2024, 2025 (gaps due to CDE reporting changes)
grad_multi <- fetch_graduation_multi(c(2018, 2019, 2022, 2024, 2025), use_cache = TRUE)

# Check available years
grad_multi %>%
  filter(is_state, subgroup == "all") %>%
  select(end_year, grad_rate, cohort_count)
```

## Statewide Trends

### Overall Graduation Rate Trend

```{r state-trend, fig.cap="California statewide graduation rate trend"}
state_trend <- grad_multi %>%
  filter(is_state, subgroup == "all")

stopifnot(nrow(state_trend) > 0)

state_trend %>%
  select(end_year, grad_rate) %>%
  print()

ggplot(state_trend, aes(x = end_year, y = grad_rate)) +
  geom_line(linewidth = 1, color = "#0078D4") +
  geom_point(size = 3, color = "#0078D4") +
  geom_text(aes(label = paste0(round(grad_rate * 100, 1), "%")),
            vjust = -1, size = 3.5) +
  labs(
    title = "California Statewide Graduation Rate Trend",
    subtitle = "4-year cohort, all students (2018-2025)",
    x = "School Year End",
    y = "Graduation Rate",
    caption = "Source: California Department of Education"
  ) +
  scale_y_continuous(limits = c(0.80, 0.95),
                     labels = scales::percent_format(accuracy = 1)) +
  theme_minimal()
```

**Key Finding:** Statewide graduation rates have improved from about 84% in 2018 to 88% in 2025, with data gaps in 2020-2021 and 2023 due to pandemic reporting changes.

## Demographic Disparities

### Graduation Rates by Student Group

```{r demographic-chart, fig.cap="Graduation rates by demographic group 2024"}
demo_data <- grad_2024 %>%
  filter(
    is_state,
    subgroup %in% c("all", "hispanic", "white", "asian", "black", "low_income")
  )

stopifnot(nrow(demo_data) > 0)

demo_data %>%
  select(subgroup, grad_rate, cohort_count) %>%
  arrange(desc(grad_rate)) %>%
  print()

demo_data %>%
  arrange(desc(grad_rate)) %>%
  mutate(subgroup = factor(subgroup, levels = subgroup)) %>%
  ggplot(aes(x = subgroup, y = grad_rate, fill = subgroup)) +
  geom_col() +
  geom_text(aes(label = paste0(round(grad_rate * 100, 1), "%")),
            hjust = -0.1, size = 3.5) +
  coord_flip() +
  labs(
    title = "California Graduation Rates by Demographic Group (2024)",
    subtitle = "Significant disparities exist across student groups",
    x = "",
    y = "Graduation Rate",
    caption = "Source: California Department of Education"
  ) +
  scale_y_continuous(limits = c(0, 1.05),
                     labels = scales::percent_format(accuracy = 1)) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "none")
```

**Key Finding:** Graduation rates vary by demographic group, with Asian students graduating at about 92% and Black students at about 79% -- a 13 percentage point gap.

## District-Level Analysis

### Top Performing Districts

```{r top-districts, fig.cap="Top 10 districts by graduation rate"}
top_districts <- grad_2024 %>%
  filter(
    is_district,
    subgroup == "all",
    cohort_count >= 500
  ) %>%
  arrange(desc(grad_rate)) %>%
  head(10)

stopifnot(nrow(top_districts) > 0)

top_districts %>%
  select(district_name, grad_rate, cohort_count) %>%
  print()

ggplot(top_districts, aes(x = reorder(district_name, grad_rate), y = grad_rate)) +
  geom_col(fill = "#107C41") +
  geom_text(aes(label = paste0(round(grad_rate * 100, 1), "%")),
            hjust = -0.1, size = 3) +
  coord_flip() +
  labs(
    title = "Top 10 California Districts by Graduation Rate (2024)",
    subtitle = "Districts with 500+ student cohorts",
    x = "",
    y = "Graduation Rate",
    caption = "Source: California Department of Education"
  ) +
  scale_y_continuous(limits = c(0, 1.05),
                     labels = scales::percent_format(accuracy = 1)) +
  theme_minimal()
```

### Finding Districts with Improving Trends

```{r district-trends}
# Identify districts with improvement over time
# Use district_id to avoid issues with duplicate district names across counties
district_trends <- grad_multi %>%
  filter(
    is_district,
    subgroup == "all",
    cohort_count >= 100
  ) %>%
  group_by(district_id, district_name) %>%
  filter(n() >= 3) %>%  # Districts with at least 3 data points
  summarize(
    first_year = min(end_year),
    last_year = max(end_year),
    first_rate = grad_rate[end_year == min(end_year)],
    last_rate = grad_rate[end_year == max(end_year)],
    improvement = grad_rate[end_year == max(end_year)] - grad_rate[end_year == min(end_year)],
    .groups = "drop"
  ) %>%
  filter(!is.na(improvement)) %>%
  arrange(desc(improvement)) %>%
  head(10)

stopifnot(nrow(district_trends) > 0)

district_trends %>%
  mutate(
    first_rate_pct = paste0(round(first_rate * 100, 1), "%"),
    last_rate_pct = paste0(round(last_rate * 100, 1), "%"),
    improvement_pct = paste0("+", round(improvement * 100, 1), "%")
  ) %>%
  select(district_name, first_year, last_year, first_rate_pct, last_rate_pct, improvement_pct)
```

### Case Study: High-Performing Districts vs State Average

```{r case-study, fig.cap="District comparison: top performers vs state average"}
# Select top 5 districts by graduation rate
top5_names <- grad_2024 %>%
  filter(
    is_district,
    subgroup == "all",
    cohort_count >= 500
  ) %>%
  arrange(desc(grad_rate)) %>%
  head(5) %>%
  pull(district_name)

# Compare these districts with state average over time
case_study <- grad_multi %>%
  filter(
    subgroup == "all",
    is_state | district_name %in% top5_names
  ) %>%
  mutate(
    label = ifelse(is_state, "State Average", district_name)
  )

stopifnot(nrow(case_study) > 0)

case_study %>%
  dplyr::as_tibble() %>%
  select(end_year, label, grad_rate) %>%
  print(n = 30)

ggplot(case_study, aes(x = end_year, y = grad_rate, color = label, group = label)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(
    title = "Graduation Rate Trends: Top Districts vs State Average",
    subtitle = "High-performing districts consistently maintain >95% graduation rates",
    x = "School Year End",
    y = "Graduation Rate",
    color = "",
    caption = "Source: California Department of Education"
  ) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## Data Quality Notes

### Coverage and Limitations

```{r coverage}
# Check data coverage by year
grad_multi %>%
  filter(subgroup == "all") %>%
  group_by(end_year) %>%
  summarise(
    n_schools = sum(type == "School" & !is.na(grad_rate)),
    n_districts = sum(type == "District" & !is.na(grad_rate)),
    .groups = "drop"
  )
```

**Important notes:**
- Data available from 2018 onwards (2017 URL returns 404)
- No data for 2020, 2021, or 2023 due to pandemic-related reporting changes
- Small schools/districts may have suppressed data for privacy
- Graduation rates calculated per California's adjusted cohort formula
- Some student groups may have small cohort sizes affecting reliability

## Advanced Analysis

### Identifying Outlier Schools

```{r outliers}
# Find schools with unusual graduation rates (for investigation)
outliers <- grad_2024 %>%
  filter(
    type == "School",
    subgroup == "all",
    cohort_count >= 30,
    !is.na(grad_rate)
  ) %>%
  mutate(
    z_score = scale(grad_rate)[,1],
    is_outlier = abs(z_score) > 2
  ) %>%
  filter(is_outlier) %>%
  arrange(desc(abs(z_score))) %>%
  select(school_name, district_name, grad_rate, cohort_count, z_score) %>%
  head(10)

outliers
```

These schools merit further investigation to understand best practices or areas needing support.

## Summary

This vignette demonstrated how to:

1. **Fetch** graduation rate data for single or multiple years
2. **Analyze** statewide trends and district performance
3. **Compare** graduation rates across demographic groups
4. **Identify** disparities and high-performing districts

**Next steps:**
- Explore the `district-highlights` vignette for deeper enrollment analysis
- Use `data-quality-qa` vignette to understand data quality considerations
- Combine enrollment and graduation data for comprehensive analyses

For more information, see the [caschooldata documentation](https://almartin82.github.io/caschooldata/).

## Session Info

```{r session-info}
sessionInfo()
```
