---
title: "California Graduation Rate Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{California Graduation Rate Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,
  fig.height = 4.5,
  cache = TRUE
)
```

## Overview

California's graduation rates vary significantly across districts, demographics, and student groups. This vignette shows how to fetch and analyze graduation rate data from the California Department of Education.

**Key insights you'll discover:**
- Statewide graduation rates have remained stable at ~87%
- Significant disparities exist across demographic groups
- Top-performing districts maintain >95% graduation rates

## Fetching Graduation Data

### Single Year

Fetch graduation rates for a specific school year:

```{r fetch-single}
library(caschooldata)
library(dplyr)
library(ggplot2)

# Get 2024 graduation rates (2023-24 school year)
grad_2024 <- fetch_graduation(2024, use_cache = TRUE)

stopifnot(nrow(grad_2024) > 0)

# Statewide overview
grad_2024 %>%
  filter(is_state, subgroup == "all") %>%
  select(grad_rate, cohort_count, graduate_count) %>%
  head()
```

### Multiple Years

Fetch multiple years for trend analysis:

```{r fetch-multi, cache=FALSE}
# Get multiple years of graduation data
# Note: Available years are 2018-2019, 2022, 2024-2025 (2017 returns 404)
grad_multi <- fetch_graduation_multi(c(2018, 2019, 2022, 2024), use_cache = TRUE)

stopifnot(nrow(grad_multi) > 0)

# Check available years
grad_multi %>%
  filter(is_state, subgroup == "all") %>%
  count(end_year)
```

## Statewide Trends

### Overall Graduation Rate Trend

```{r state-trend, fig.cap="California statewide graduation rate trend"}
state_grad <- grad_multi %>%
  filter(is_state, subgroup == "all")

stopifnot(nrow(state_grad) > 0)

state_grad %>% select(end_year, grad_rate, cohort_count, graduate_count)

ggplot(state_grad, aes(x = end_year, y = grad_rate)) +
  geom_line(linewidth = 1, color = "#0078D4") +
  geom_point(size = 3, color = "#0078D4") +
  labs(
    title = "California Statewide Graduation Rate Trend",
    subtitle = "4-year cohort, all students (2018-2024)",
    x = "School Year End",
    y = "Graduation Rate (%)",
    caption = "Source: California Department of Education"
  ) +
  scale_y_continuous(limits = c(80, 95), labels = scales::percent_format(scale = 1)) +
  theme_minimal()
```

**Key Finding:** Statewide graduation rates have remained stable around 87-88%, with data gaps in 2020-2021 and 2023 due to reporting changes during the pandemic.

## Demographic Disparities

### Graduation Rates by Student Group

```{r demographic-chart, fig.cap="Graduation rates by demographic group 2024"}
demo_data <- grad_2024 %>%
  filter(
    is_state,
    subgroup %in% c("all", "hispanic", "white", "asian", "black", "low_income")
  )

stopifnot(nrow(demo_data) > 0)

demo_data %>%
  select(subgroup, grad_rate, cohort_count) %>%
  arrange(desc(grad_rate))

demo_data %>%
  arrange(desc(grad_rate)) %>%
  mutate(subgroup = factor(subgroup, levels = subgroup)) %>%
  ggplot(aes(x = subgroup, y = grad_rate, fill = subgroup)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "California Graduation Rates by Demographic Group (2024)",
    subtitle = "Significant disparities exist across student groups",
    x = "",
    y = "Graduation Rate (%)",
    fill = "Student Group",
    caption = "Source: California Department of Education"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "none")
```

## District-Level Analysis

### Finding Districts with Improving Trends

```{r district-trends}
# Identify districts with improvement over time
district_trends <- grad_multi %>%
  filter(
    !is_state,
    type == "District",
    subgroup == "all",
    cohort_count >= 100  # Sufficient data
  ) %>%
  group_by(district_id, district_name) %>%
  filter(n() >= 2) %>%
  arrange(end_year) %>%
  summarize(
    first_year = first(end_year),
    last_year = last(end_year),
    first_rate = first(grad_rate),
    last_rate = last(grad_rate),
    improvement = last(grad_rate) - first(grad_rate),
    .groups = "drop"
  ) %>%
  filter(!is.na(improvement)) %>%
  arrange(desc(improvement)) %>%
  head(10)

stopifnot(nrow(district_trends) > 0)

district_trends %>%
  mutate(
    first_rate_pct = paste0(round(first_rate, 1), "%"),
    last_rate_pct = paste0(round(last_rate, 1), "%"),
    improvement_pct = paste0(round(improvement, 1), "%")
  ) %>%
  select(district_name, first_year, last_year, first_rate_pct, last_rate_pct, improvement_pct)
```

### Case Study: High-Performing Districts

```{r case-study, fig.cap="District comparison: top performers vs state average"}
# Select top 5 districts by graduation rate
top_districts <- grad_2024 %>%
  filter(
    type == "District",
    subgroup == "all",
    cohort_count >= 500
  ) %>%
  arrange(desc(grad_rate)) %>%
  head(5) %>%
  pull(district_name)

# Compare these districts with state average over time
case_study <- grad_multi %>%
  filter(
    subgroup == "all",
    is_state | district_name %in% top_districts
  ) %>%
  mutate(
    label = ifelse(is_state, "State Average", district_name)
  )

stopifnot(nrow(case_study) > 0)

case_study %>%
  ggplot(aes(x = end_year, y = grad_rate, color = label, group = label)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(
    title = "Graduation Rate Trends: Top Districts vs State Average",
    subtitle = "High-performing districts maintain >90% graduation rates",
    x = "School Year End",
    y = "Graduation Rate (%)",
    color = "",
    caption = "Source: California Department of Education"
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  scale_color_brewer(palette = "Set1") +
  theme_minimal()
```

## Data Quality Notes

### Coverage and Limitations

```{r coverage}
# Check data coverage by year
grad_multi %>%
  filter(subgroup == "all") %>%
  group_by(end_year) %>%
  summarise(
    n_schools = sum(type == "School" & !is.na(grad_rate)),
    n_districts = sum(type == "District" & !is.na(grad_rate)),
    .groups = "drop"
  )
```

**Important notes:**
- Data available from 2018 onwards (2017 URL returns 404)
- Small schools/districts may have suppressed data for privacy
- Graduation rates calculated per California's adjusted cohort formula
- Some student groups may have small cohort sizes affecting reliability

## Summary

This vignette demonstrated how to:

1. **Fetch** graduation rate data for single or multiple years
2. **Analyze** statewide trends and district performance
3. **Compare** graduation rates across demographic groups
4. **Identify** disparities and high-performing districts

**Next steps:**
- Explore the `district-highlights` vignette for deeper district-level analysis
- Use `data-quality-qa` vignette to understand data quality considerations
- Combine enrollment and graduation data for comprehensive analyses

For more information, see the [caschooldata documentation](https://almartin82.github.io/caschooldata/).

## Session Info

```{r session-info}
sessionInfo()
```
